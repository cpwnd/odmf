

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en-EN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en-EN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Development &mdash; ODMF Docs 0.1.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Views" href="views.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> ODMF Docs
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="about.html">What is ODMF</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage/ Tutorial/ Wiki</a></li>
<li class="toctree-l1"><a class="reference internal" href="views.html">Views</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Development</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#core-thoughts-behind-design-decisions">Core thoughts behind design decisions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#database-erm">Database (ERM)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#database-orm-mapping">Database (ORM mapping)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dataset">Dataset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#valuetype">Valuetype</a></li>
<li class="toctree-l3"><a class="reference internal" href="#job">Job</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#database-sql">Database (SQL)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#odmf-schema-model">ODMF Schema Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#view-odm-seriescatalog">View <code class="docutils literal notranslate"><span class="pre">ODM.Seriescatalog</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#upload-or-dataimport">Upload or Dataimport</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#import-process">Import process</a></li>
<li class="toctree-l3"><a class="reference internal" href="#xlsimport">XlsImport</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conf-files"><code class="docutils literal notranslate"><span class="pre">.conf</span></code>-files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#migration">Migration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#wateroneflow">WaterOneFlow</a></li>
<li class="toctree-l3"><a class="reference internal" href="#schema-mapping-validity">Schema mapping validity</a></li>
<li class="toctree-l3"><a class="reference internal" href="#daily-jobs">Daily jobs</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ODMF Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Development</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/odmf/development.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="development">
<span id="development"></span><h1>Development<a class="headerlink" href="#development" title="Permalink to this headline">¶</a></h1>
<p>This chapter is intended to give an overview about the source code structure and the server stack used for ODMF. Also
it let you understand the database schema which is essential to the development, since a ORM framework is in use.
So this chapter should be referred to, when developing the platform.
At the beginning there is a brief introduction to the design of the server system. After getting a overview of the
platform and its coherences, the <a class="reference external" href="development.html#database-erm">database</a> is described briefly and the
<a class="reference external" href="development.html#database-orm-mapping">ORM mapping</a> is explained in detail, so when developing you can make use of
the <code class="docutils literal notranslate"><span class="pre">odmf.db</span></code>-package.</p>
<p>In the following picture the server stack, consisting of the backend framework <a class="reference external" href="https://cherrypy.org">cherrypy</a>, which
connects the <a class="reference external" href="https://postgres.org">postgres</a> database and renders with the help of templating engine
<a class="reference external" href="https://genshi.edgewall.org/">genshi</a> the HTML content and a bit of <a class="reference external" href="https://jquery.org">jquery</a>.
Speaking of the server code, the database is accessed consistently via the ORM-mapping framework <a class="reference external" href="https://www.sqlalchemy.org">sqlalchemy</a>.
The Cherrypy server also exposes some methods as JSON exports for a rest-like use of data retrieval.</p>
<p><img alt="Picture of the ODMF database schema" src="../_images/server-stack.jpg" /></p>
<p>The development was done between 2013-today partially by a team of one or two developers. There are some acceptance
and ui tests, but no unit tests.</p>
<p>The code base is divided in three main parts. <strong>Server</strong>, <strong>automated import</strong> and
<strong>database communication</strong>.</p>
<ul class="simple">
<li>Most of the <strong>server</strong> functionality is in the <code class="docutils literal notranslate"><span class="pre">webpage</span></code> module. It covers starting
and stopping the server. Exposing of webpages and data endpoints.<ul>
<li>Module <code class="docutils literal notranslate"><span class="pre">pages</span></code> contains all pages, unless they are <code class="docutils literal notranslate"><span class="pre">plot</span></code>, <code class="docutils literal notranslate"><span class="pre">site</span></code>, <code class="docutils literal notranslate"><span class="pre">upload</span></code>, <code class="docutils literal notranslate"><span class="pre">dataset</span></code> or <code class="docutils literal notranslate"><span class="pre">map</span></code>.
In <code class="docutils literal notranslate"><span class="pre">webpage/lib.py</span></code> is utility code.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">auth</span></code> module is based on the <code class="docutils literal notranslate"><span class="pre">bcrypt</span></code> hashing implementation.</li>
</ul>
</li>
<li><strong>automated import</strong> functions reside in <code class="docutils literal notranslate"><span class="pre">dataimport</span></code> module.</li>
<li><strong>database</strong> and ORM code is in <code class="docutils literal notranslate"><span class="pre">db</span></code> the module.</li>
</ul>
<p>Utility code for calibration, conf and markdown parsing are saved in the <code class="docutils literal notranslate"><span class="pre">tools</span></code> module.</p>
<div class="section" id="core-thoughts-behind-design-decisions">
<span id="core-thoughts-behind-design-decisions"></span><h2>Core thoughts behind design decisions<a class="headerlink" href="#core-thoughts-behind-design-decisions" title="Permalink to this headline">¶</a></h2>
<p>To connect more of the ideas under the hood of the server there are diagrams describing the user interaction for the most important functions of the platform.</p>
<ul class="simple">
<li>Schwingbach FMC (Detail)<ul>
<li>User interaction (WOF)</li>
<li>User interaction (data import)</li>
<li>…</li>
</ul>
</li>
<li>CUAHSI WOF transactions diagram</li>
<li>Views a. CV-Tables extending ODMF data schema</li>
</ul>
<div class="section" id="database-erm">
<span id="database-erm"></span><h3>Database (ERM)<a class="headerlink" href="#database-erm" title="Permalink to this headline">¶</a></h3>
<p><img alt="Picture of the ODMF database schema" src="../_images/schwingbach1.png" /></p>
</div>
</div>
<div class="section" id="database-orm-mapping">
<span id="database-orm-mapping"></span><h2>Database (ORM mapping)<a class="headerlink" href="#database-orm-mapping" title="Permalink to this headline">¶</a></h2>
<p>The Python ORM framework <a class="reference external" href="https://www.sqlalchemy.org">SQLalchemy</a> is used for handling data transactions for user
administration, field data import and metadata annotation.</p>
<p>In the relation <code class="docutils literal notranslate"><span class="pre">dataset</span></code> many foreign keys are stored, which point to other relations and additional metadata.
The most important are <code class="docutils literal notranslate"><span class="pre">site</span></code>, <code class="docutils literal notranslate"><span class="pre">valuetype</span></code> and <code class="docutils literal notranslate"><span class="pre">source</span></code>, of which the primary key of dataset consists.
The other foreign keys affiliation is straight forward.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">record</span></code> relation keeps the essential data rows, that describe the measured data. Each row belongs to a <code class="docutils literal notranslate"><span class="pre">dataset</span></code> relation, which then extends the known data about it.</p>
<p>In the relation <code class="docutils literal notranslate"><span class="pre">person</span></code> all the user data is stored. Further the relation <code class="docutils literal notranslate"><span class="pre">job</span></code> contains a metadata to tasks, that are
assigned to a person. A element of relation <code class="docutils literal notranslate"><span class="pre">dataset</span></code> is assigned via <code class="docutils literal notranslate"><span class="pre">measured_by</span></code> to a <code class="docutils literal notranslate"><span class="pre">person</span></code> too.</p>
<div class="section" id="dataset">
<span id="dataset"></span><h3>Dataset<a class="headerlink" href="#dataset" title="Permalink to this headline">¶</a></h3>
<p>Distinction between <code class="docutils literal notranslate"><span class="pre">timeseries</span></code> and <code class="docutils literal notranslate"><span class="pre">transformed_timeseries</span></code>.</p>
<p>A dataset object has a so called back reference to records with a <code class="docutils literal notranslate"><span class="pre">lazy</span></code> join on the records, regarding the dataset.
<a class="reference external" href="http://docs.sqlalchemy.org/en/latest/orm/backref.html">See sqlalchemy docs</a> on backref.</p>
</div>
<div class="section" id="valuetype">
<span id="valuetype"></span><h3>Valuetype<a class="headerlink" href="#valuetype" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="job">
<span id="job"></span><h3>Job<a class="headerlink" href="#job" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="database-sql">
<span id="database-sql"></span><h2>Database (SQL)<a class="headerlink" href="#database-sql" title="Permalink to this headline">¶</a></h2>
<div class="section" id="odmf-schema-model">
<span id="odmf-schema-model"></span><h3>ODMF Schema Model<a class="headerlink" href="#odmf-schema-model" title="Permalink to this headline">¶</a></h3>
<p>Elaborate on the ODMF (NOT ODM Schema model)</p>
</div>
<div class="section" id="view-odm-seriescatalog">
<span id="view-odm-seriescatalog"></span><h3>View <code class="docutils literal notranslate"><span class="pre">ODM.Seriescatalog</span></code><a class="headerlink" href="#view-odm-seriescatalog" title="Permalink to this headline">¶</a></h3>
<p>To provide the <code class="docutils literal notranslate"><span class="pre">begindatetimeutc</span></code> and <code class="docutils literal notranslate"><span class="pre">enddatetimeutc</span></code> of <code class="docutils literal notranslate"><span class="pre">SBO.seriescatalog</span></code>, the attributes <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">end</span></code> of
<code class="docutils literal notranslate"><span class="pre">SBO.dataset</span></code> are totalled up with <code class="docutils literal notranslate"><span class="pre">timezone</span></code> of <code class="docutils literal notranslate"><span class="pre">dataset</span></code> and the <code class="docutils literal notranslate"><span class="pre">pg_timezone_names.utc_offset</span></code>.
<a class="reference external" href="https://www.postgresql.org/docs/current/static/datatype-datetime.html#DATATYPE-TIMEZONES">See Postgresql docs</a> on
timezones.</p>
</div>
</div>
<div class="section" id="upload-or-dataimport">
<span id="upload-or-dataimport"></span><h2>Upload or Dataimport<a class="headerlink" href="#upload-or-dataimport" title="Permalink to this headline">¶</a></h2>
<p>Corresponds to the <code class="docutils literal notranslate"><span class="pre">/odmf/dataimport</span></code> directory.</p>
<p>This directory holds the files <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> and <code class="docutils literal notranslate"><span class="pre">base.py</span></code> which mainly provide some kind of abstract skeleton for the
data import. The other files go along with a descriptive filename, which is similar to names of the file including
class. For example <code class="docutils literal notranslate"><span class="pre">XlsImport</span></code> is for the import of <code class="docutils literal notranslate"><span class="pre">xls(x)</span></code> files.</p>
<p>Upload and data import is part of the <em>automated import</em> and is further explained in the
<a class="reference external" href="usage.html#import-data">usage</a> chapter.</p>
<div class="section" id="import-process">
<span id="import-process"></span><h3>Import process<a class="headerlink" href="#import-process" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="xlsimport">
<span id="xlsimport"></span><h3>XlsImport<a class="headerlink" href="#xlsimport" title="Permalink to this headline">¶</a></h3>
<p>Corresponds to <code class="docutils literal notranslate"><span class="pre">odmf/dataimport/xls.py</span></code></p>
</div>
<div class="section" id="conf-files">
<span id="conf-files"></span><h3><code class="docutils literal notranslate"><span class="pre">.conf</span></code>-files<a class="headerlink" href="#conf-files" title="Permalink to this headline">¶</a></h3>
<p>The conf file upload is implemented in <code class="docutils literal notranslate"><span class="pre">dataimport.ImportDescription</span></code> and <code class="docutils literal notranslate"><span class="pre">dataimport.ImportColumn</span></code>.</p>
<p>If the configparser module cannot parse a file, the <code class="docutils literal notranslate"><span class="pre">UnicodeDecodeError</span></code> is catched and a the estimated encoding
is returned to the user, as part of an error message.</p>
</div>
</div>
<div class="section" id="migration">
<span id="migration"></span><h2>Migration<a class="headerlink" href="#migration" title="Permalink to this headline">¶</a></h2>
<p>Differences of the database schemas of ODMF and ODM:</p>
<ul class="simple">
<li>odmf.dataset attributes start and end, can be identical in the rare case of a size of just one record.</li>
</ul>
<div class="section" id="wateroneflow">
<span id="wateroneflow"></span><h3>WaterOneFlow<a class="headerlink" href="#wateroneflow" title="Permalink to this headline">¶</a></h3>
<p>Details on the implementation of the WaterOneFlow interface for ODMF server software.</p>
<ul class="simple">
<li>What parts communicate how</li>
<li>SQL Views as mapping from ODMF schema to ODM schema</li>
</ul>
</div>
<div class="section" id="schema-mapping-validity">
<span id="schema-mapping-validity"></span><h3>Schema mapping validity<a class="headerlink" href="#schema-mapping-validity" title="Permalink to this headline">¶</a></h3>
<p>It’s important to check on the schema mapping validity, since the Schwingbach database schema is extended through different
database views to fit CUAHSI ODM schema, which is used with the HydroServerLite instance.</p>
<p>The helper view <code class="docutils literal notranslate"><span class="pre">sbo_odm_invalid_datasets</span></code> returns all <code class="docutils literal notranslate"><span class="pre">dataset</span></code>s which will break the ODM schema constraints, when these
datasets are extended through the database views. To prevent this break, the view <code class="docutils literal notranslate"><span class="pre">seriescatalog</span></code> filters based on
this helper view invalid datasets from being published through itself.</p>
</div>
<div class="section" id="daily-jobs">
<span id="daily-jobs"></span><h3>Daily jobs<a class="headerlink" href="#daily-jobs" title="Permalink to this headline">¶</a></h3>
<p>Creation of the transformed timeseries</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="views.html" class="btn btn-neutral" title="Views" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Philipp Kraft, Chris Weber

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'0.1.1',
              LANGUAGE:'en-EN',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>